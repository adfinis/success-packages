<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>Vault administration</title>
    <link rel="shortcut icon" href="./favicon.ico" />
    <link rel="stylesheet" href="./dist/reset.css" />
    <link rel="stylesheet" href="./dist/reveal.css" />
    <link rel="stylesheet" href="./dist/theme/night.css" id="theme" />
    <link rel="stylesheet" href="./css/highlight/base16/zenburn.css" />

    <link rel="stylesheet" href="./reveal-md/reveal-md/css/custom-night.css" />

  </head>
  <body>
    <div class="reveal">
      <div class="slides"><section  data-markdown><script type="text/template">

# Vault Administration
</script></section><section  data-markdown><script type="text/template">
A guide that goes deeper into

HashiCorp Vault Administration
</script></section><section  data-markdown><script type="text/template">
## Topics 1/2

- Tokens
  - Token types
  - Token leases
- Policies
  - Writing policies
  - Templating policies
</script></section><section  data-markdown><script type="text/template">
## Topics 2/2

- Engines
  - Auth engines
  - Secrets engines
- Configuration
  - UI
  - CLI
  - Terraform
</script></section><section  data-markdown><script type="text/template">
## Tokens 

Tokens are the core method for **authentication** of clients within Vault

> Nearly all requests to Vault must be accompanied by a token

Tokens are authenticated by an **auth method**
</script></section><section ><section data-markdown><script type="text/template">
### Token types

Vault token types

Dive deeper ↓
</script></section><section data-markdown><script type="text/template">
#### 1/4 Token types - service and batch tokens

Two main types of Vault tokens: 

| Token type | Example     |
|:----------:|:-----------:|
| Service    | hv**s**.xxx |
| Batch      | hv**b**.xxx |
</script></section><section data-markdown><script type="text/template">
#### 2/4 Token types - recovery token

- Then there's also a special **recovery** token
- It's only used in case a recovery scenario if needed
- Look into this [tutorial](https://developer.hashicorp.com/vault/docs/concepts/recovery-mode) if you want to learn more
</script></section><section data-markdown><script type="text/template">
#### 3/4 Token types - token comparison

- **Service token**:
  - heavyweight; multiple storage writes per token creation
  - persisted; can be **renewed**, **revoked**, and create **children**

- **Batch tokens**:
  - lightweight; no storage cost for token creation
  - binary large objects (blobs); **NOT** persisted (ephemeral)
</script></section><section data-markdown><script type="text/template">
#### 4/4 Token types - Vault CLI

Run `vault token --help` to display:

```yaml
Usage: vault token <subcommand> [options] [args]

  This command groups subcommands for interacting with tokens. Users can
  create, lookup, renew, and revoke tokens.

  Create a new token:

      $ vault token create

  Revoke a token:

      $ vault token revoke 96ddf4bc-d217-f3ba-f9bd-017055595017

  Renew a token:

      $ vault token renew 96ddf4bc-d217-f3ba-f9bd-017055595017

  Please see the individual subcommand help for detailed usage information.

Subcommands:
    capabilities    Print capabilities of a token on a path
    create          Create a new token
    lookup          Display information about a token
    renew           Renew a token lease
    revoke          Revoke a token and its children
```
</script></section></section><section  data-markdown><script type="text/template">
## Vault lab with docker-compose

Let's start a lab that we will use throughout the training!

(make sure docker(-compose) is installed and the daemon is started)

First terminal tab:
```sh
cd assets/vault-docker-compose
docker-compose up
```

Second terminal tab:
```sh
export VAULT_ADDR=http://127.0.0.1:8200

vault status # to confirm it worked

Key             Value
---             -----
Seal Type       shamir
Initialized     true
Sealed          false
Total Shares    1
Threshold       1
Version         1.16.2
Build Date      2024-04-22T16:25:54Z
Storage Type    inmem
Cluster Name    vault-cluster-9508bdb6
Cluster ID      54f061c0-58c5-b5dc-6b56-e03c0e4f8771
HA Enabled      false
```
</script></section><section ><section data-markdown><script type="text/template">
## Token leases

Vault token leases and expiration

Dive deeper ↓
</script></section><section data-markdown><script type="text/template">
### 1/4 Token leases - service token lifecycle

> Every **non-root** token has a *time-to-live* (TTL)

- Leases created by **service tokens** are *tracked*, and *revoked* when the token expires
- When creating a new token, the logged in token becomes the **parent token**
- Once the **parent token** expires, all **child tokens** also expire (regardless of their own TTLs)

```shell
hvs.b519c6aa... (1h)
|___ hvs.6a2cf3e7... (4h)
|___ hvs.1d3fd4b2... (2h)
      |___ hvs.794b6f2f... (3h)
```
</script></section><section data-markdown><script type="text/template">
#### 2/6 Token leases - inspect leases in the UI

Terminal tab:
```sh
vault login
<fill 'manual-root-token'>
vault token create
```

Web tab:
- Go to Access -> Leases -> Auth -> Token -> Create
- Or visit this [link](http://127.0.0.1:8200/ui/vault/access/leases/list/auth/token/create/)
</script></section><section data-markdown><script type="text/template">
#### 3/6 Token leases - renewing service tokens

Service tokens can be renewed:
```sh
vault token create -policy="default" # service tokens are created by default

Key                  Value
---                  -----
token                hvs.CAESIJR3kLvorH_RGRwaQt-Axb59BqBfXgw1KNHvppliY6d1Gh4KHGh2cy5wRTdyUDl2a3l
CZlVtZGtCNzNLU3h3WUg < service token starts with 'hvs.'
token_accessor       C0wOfKMTBseE9KOPuSwyEafW
token_duration       768h
token_renewable      true             < service token is renewable
token_policies       ["default"]
identity_policies    []
policies             ["default"]
```</script></section><section data-markdown><script type="text/template">
#### 4/6 Token leases - renewing batch tokens

While batch tokens cannot be renewed:
```sh
vault token create -policy="default" -type="batch" # we are creating a batch token this time

Key                  Value
---                  -----
token                hvb.AAAAAQLv7-osWSc4eJ46P0wykdTKfj3lW8IBeBhX2vnKAHwQ7IhFWRayIIRRXZcnHXHNPZsdbNn91XdghJhidb
S0NgLVT3fXeqnx3hPL1ByWWhlvRBXixuxwVFyDDyKqyBfjaFHV50jo2CntQbipKvgxkyWUVh2YqYLv < batch token starts with 'hvb.'
token_accessor       n/a
token_duration       768h
token_renewable      false            < batch token is NOT renewable
token_policies       ["default"]
identity_policies    []
policies             ["default"]
```
</script></section><section data-markdown><script type="text/template">
#### 5/6 Token leases - batch token limitations

Renewing batch tokens is not possible!
```sh
$ vault token renew <batch-token>

Error renewing token: Error making API request.

URL: PUT http://127.0.0.1:8200/v1/auth/token/renew
Code: 400. Errors:

* batch tokens cannot be renewed
```

Revoking batch tokens is not possible!
```sh
$ vault token revoke <batch-token>

Error revoking token: Error making API request.

URL: PUT http://127.0.0.1:8200/v1/auth/token/revoke
Code: 400. Errors:

* batch tokens cannot be revoked
```
</script></section></section><section  data-markdown><script type="text/template">
## Policies

- Next topic covers **policies**
- **Tokens** are mapped to **policies**
- Policies describe **permissions** attached to a Vault token

```sh
vault token create -policy="default" < attached default policy to token
```
</script></section><section ><section data-markdown><script type="text/template">
### Writing policies

Vault policies and how to write them

Dive deeper ↓
</script></section><section data-markdown><script type="text/template">
#### 1/8 Writing policies

- Everything in Vault is path based (path corresponds to Vault API endpoints)
- Policies **grant** or **forbid** access to certain paths and operations

```hcl
path "<PATH>" {
  capabilities = [ "<LIST_OF_PERMISSIONS>" ]
}
```
</script></section><section data-markdown><script type="text/template">
#### 2/8 Writing policies

- Policies may include all or some of the following permissions (capabilities):

```hcl
path "<PATH>" {
  capabilities = ["create", "read", "update", "delete", "list", "sudo"]
}
```
</script></section><section data-markdown><script type="text/template">
#### 3/8 Writing policies

These are the policy [capabilities](https://developer.hashicorp.com/vault/docs/concepts/policies#capabilities), simply explained:

| Capability | Description                                                        |
|------------|--------------------------------------------------------------------|
| create     | Allows **creating** data at the given path                         |
| read       | Allows **reading** the data at the given path                      |
| update     | Allows **changing** the data at the given path                     |
| delete     | Allows **deleting** the data at the given path                     |
| list       | Allows **listing** values at the given path                        |
| patch      | Allows partial **updates** to the data at a given path (versioned) |
| sudo       | Allows access to paths that are **root-protected**                 |
| deny       | **Disallows** access (takes precedence over everything else)       |
</script></section><section data-markdown><script type="text/template">
#### 4/8 Writing policies

These are the equivalent HTTP verbs to use when creating API requests

| Capability | HTTP equivalent |
|:----------:|:---------------:|
| create     | POST/PUT        |
| read       | GET             |
| update     | POST/PUT        |
| delete     | DELETE          |
| list       | LIST            |
| patch      | PATCH           |
| sudo       | -               |
| deny       | -               |

```sh
curl --header "X-Vault-Token: $VAULT_TOKEN" \
     --request POST \
     --data '{"data":{"foo":"bar"}}' \
     http://127.0.0.1:8200/v1/secret/data/my-secret
```
</script></section><section data-markdown><script type="text/template">
#### 5/8 Writing policies - root policy

- Root policy is always included – superuser with all permissions
- The root policy is not visible in the Vault backend
- It can be thought of as (not valid HCL):

```hcl
path "*" {
  capabilities = ["create", "read", "update", "delete", "list", "sudo"]
}
```
</script></section><section data-markdown><script type="text/template">
#### 6/8 Writing policies - root policy

- Only use the root token to:
  - Setup initial policies and configurations
  - Handle emergencies where root privilege is needed
</script></section><section data-markdown><script type="text/template">
#### 7/8 Writing policies - default policy

- The default policy is always included
- Contains common permissions around token and backend features
- Take a moment to study the contents of the default [policy](http://127.0.0.1:8200/ui/vault/policy/acl/default)
</script></section><section data-markdown><script type="text/template">
#### 8/8 Writi


</script></section></section><section ><section data-markdown><script type="text/template">
### Templating policies

Vault policy templating techniques

Dive deeper ↓
</script></section><section data-markdown><script type="text/template">
#### 1/3 Templating policies - techniques

- Policies can be templated using:
  - Wildcard (`*`)
  - Single directory (`+`)
</script></section><section data-markdown><script type="text/template">
#### 2/3 Templating policies - wildcard

ACL policy path supports wildcard (`*`) at the end of the path

```hcl
path "secret/team-*" { 
  capabilities = ["read", "list"]
}
```

Matches any path starting with `"secret/team-"`:
- `secret/team-security`
- `secret/team-a/project`
</script></section><section data-markdown><script type="text/template">
#### 3/3 Templating policies - single directory

Supports wildcard matching for a single directory in path

```hcl
path "secret/app/+/dev" { ... } < matches 'secret/app/v1/dev'
```

You can also combine both plus symbol `+` and wildcard `*`

```hcl
path "secret/app/+/team-*" { ... } < matches 'secret/app/v1/team-a'
```
</script></section></section><section  data-markdown><script type="text/template">
## Vault engines

- You can configure Vault using:
  - Auth engines
  - Secrets engines
</script></section><section ><section data-markdown><script type="text/template">
### Auth engines

Vault auth engines

Dive deeper ↓
</script></section><section data-markdown><script type="text/template">
#### 1/5 Auth engines

- Auth engines authenticate users and applications
- Many different auth engines exist
- We will cover the most common auth engines
</script></section><section data-markdown><script type="text/template">
#### 2/5 Auth engines - token

- The [token](https://developer.hashicorp.com/vault/docs/auth/token) auth method is the most basic engine
- Built-in, automatically available by default at `/auth/token`
- Allows users to:
  - authenticate using a token
  - create new tokens
  - revoke secrets by token
  - and more
</script></section><section data-markdown><script type="text/template">
#### 3/5 Auth engines - userpass

- Next up, the [userpass](https://developer.hashicorp.com/vault/docs/auth/userpass) auth engine
- Simply allows you to use standard users (with passwords) in Vault
- Usually used as an emergency backup auth method (in case dynamic auth engine fails)
</script></section><section data-markdown><script type="text/template">
#### 4/5 Auth engines - cloud auth methods

- Use your pre-existing users in cloud platforms to authenticate:
  - [AWS IAM](https://developer.hashicorp.com/vault/docs/auth/aws)
  - [Azure AD](https://developer.hashicorp.com/vault/docs/auth/azure)
  - [Gcloud IAM](https://developer.hashicorp.com/vault/docs/auth/gcp)
  - [OCI Identity](https://developer.hashicorp.com/vault/docs/auth/oci)
</script></section><section data-markdown><script type="text/template">
#### 5/5 Auth engines - common protocols

- Or use common protocols:
  - [LDAP](https://developer.hashicorp.com/vault/docs/auth/ldap)
  - [JWT/OIDC](https://developer.hashicorp.com/vault/docs/auth/jwt)
  - [SAML (enterprise feature)](https://developer.hashicorp.com/vault/docs/auth/saml)
</script></section></section><section ><section data-markdown><script type="text/template">
### Secret engines

Vault secret engines

Dive deeper ↓
</script></section><section data-markdown><script type="text/template">
#### 1/2 Secret engines (static)

- Stores static data by using a key-value store
- Think about username password combinations or API keys
- Access control through policies
</script></section><section data-markdown><script type="text/template">
#### 2/2 Secret engines (dynamic)

- Dynamic secret engines in Vault allow rotating of credentials over time
- Database credentials and cloud provider access keys
</script></section></section><section  data-markdown><script type="text/template">
## Configuration

- You can configure Vault using different approaches
- [UI](https://developer.hashicorp.com/vault/tutorials/getting-started-ui) / [API](https://developer.hashicorp.com/vault/api-docs) / [CLI](https://developer.hashicorp.com/vault/docs/commands) / [Terraform](https://registry.terraform.io/providers/hashicorp/vault) / [Python](https://hvac.readthedocs.io/)
- We will cover the CLI and Terraform approach
</script></section><section  data-markdown><script type="text/template">
### CLI

</script></section><section ><section data-markdown><script type="text/template">
### CLI

How to configure Vault using the CLI

Dive deeper ↓
</script></section><section data-markdown><script type="text/template">
#### 1/ CLI
</script></section><section data-markdown><script type="text/template">
#### 2/ CLI
</script></section></section><section ><section data-markdown><script type="text/template">
### Terraform

How to configure Vault using Terraform

Dive deeper ↓
</script></section><section data-markdown><script type="text/template">
#### 1/ Terraform - how to

- In most cases, configure Vault using the Terraform [provider](https://registry.terraform.io/providers/hashicorp/vault/latest)
- You can use Terraform [resources](https://developer.hashicorp.com/terraform/language/resources) as shown in the Vault provider [docs](https://registry.terraform.io/providers/hashicorp/vault/latest/docs) to apply configuration
</script></section><section data-markdown><script type="text/template">
#### 2/ Terraform - benefits

- The usual IaC benefits are also applicable here
- Ensure consistency and repeatability in configuration changes
- Version control for transparency and accountability (enabling tracking and auditing)
- Keep all environments consistent (dev and prod)
</script></section><section data-markdown><script type="text/template">
#### 2/ Terraform - practical application

- Configure the environment, not the actual contents of Vault
- In most cases you don't populate any actual secrets using Terraform
</script></section></section><section  data-markdown><script type="text/template">
## Questions

Feel free to ask questions!
</script></section><section  data-markdown><script type="text/template">
## Thanks

Thank you for your participation</script></section></div>
    </div>

    <script src="./dist/reveal.js"></script>

    <script src="./plugin/markdown/markdown.js"></script>
    <script src="./plugin/highlight/highlight.js"></script>
    <script src="./plugin/zoom/zoom.js"></script>
    <script src="./plugin/notes/notes.js"></script>
    <script src="./plugin/math/math.js"></script>
    <script>
      function extend() {
        var target = {};
        for (var i = 0; i < arguments.length; i++) {
          var source = arguments[i];
          for (var key in source) {
            if (source.hasOwnProperty(key)) {
              target[key] = source[key];
            }
          }
        }
        return target;
      }

      // default options to init reveal.js
      var defaultOptions = {
        controls: true,
        progress: true,
        history: true,
        center: true,
        transition: 'default', // none/fade/slide/convex/concave/zoom
        slideNumber: true,
        plugins: [
          RevealMarkdown,
          RevealHighlight,
          RevealZoom,
          RevealNotes,
          RevealMath
        ]
      };

      // options from URL query string
      var queryOptions = Reveal().getQueryHash() || {};

      var options = extend(defaultOptions, {}, queryOptions);
    </script>


    <script>
      Reveal.initialize(options);
    </script>
  </body>
</html>
